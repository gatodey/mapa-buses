<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Mapa Buses y Usuarios</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body style="margin:0; padding:0">
  <div id="map" style="width:100%; height:100vh;"></div>

  <script>
    // Inicializar mapa (centro temporal)
    var map = L.map('map').setView([-16.409, -71.537], 13);

    // Cargar mapa base OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Iconos personalizados
    var userIcon = L.icon({ 
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/149/149071.png', 
      iconSize:[30,30] 
    });
    var otherIcon = L.icon({ 
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/61/61231.png', 
      iconSize:[30,30] 
    });

    // Marcadores
    var myMarker = null;
    var usuarios = {};

    // ðŸ”‘ URL Firebase Realtime Database
    var firebaseURL = "https://buscatcher-copiar-default-rtdb.firebaseio.com/usuarios.json";

    // --- 1. Obtener ubicaciÃ³n propia y enviar a Firebase ---
    function enviarUbicacion(lat, lng) {
      // Generar ID Ãºnico por usuario
      let userId = localStorage.getItem("userId");
      if (!userId) {
        userId = "user_" + Math.floor(Math.random() * 10000);
        localStorage.setItem("userId", userId);
      }

      // Subir ubicaciÃ³n a Firebase
      fetch("https://buscatcher-copiar-default-rtdb.firebaseio.com/usuarios/" + userId + ".json", {
        method: "PUT",
        body: JSON.stringify({ lat: lat, lng: lng })
      });
    }

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(function(position) {
        var lat = position.coords.latitude;
        var lng = position.coords.longitude;

        if (!myMarker) {
          myMarker = L.marker([lat, lng], {icon: userIcon}).addTo(map).bindPopup("TÃº estÃ¡s aquÃ­");
          map.setView([lat, lng], 15);
        } else {
          myMarker.setLatLng([lat, lng]);
        }

        enviarUbicacion(lat, lng);
      });
    }

    // --- 2. Mostrar otros usuarios en el mapa ---
    async function actualizarMapa() {
      let response = await fetch(firebaseURL);
      let data = await response.json();

      if (data) {
        Object.keys(data).forEach(userId => {
          let u = data[userId];
          if (!usuarios[userId]) {
            usuarios[userId] = L.marker([u.lat, u.lng], {icon: otherIcon}).addTo(map).bindPopup("ðŸ‘¤ " + userId);
          } else {
            usuarios[userId].setLatLng([u.lat, u.lng]);
          }
        });
      }
    }

    setInterval(actualizarMapa, 4000);
    actualizarMapa();
  </script>
</body>
</html>
